<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber-Scan | Pro Bangla PDF Search</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        /* Using a reliable CDN for SolaimanLipi if local fails */
        @import url('https://fonts.cdnfonts.com/css/solaimanlipi');

        :root {
            --neon-blue: #00f3ff;
            --bg-dark: #020205;
            --glass: rgba(0, 243, 255, 0.05);
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'SolaimanLipi', Arial, sans-serif;
            background: var(--bg-dark);
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .container {
            margin-top: 5vh;
            width: 90%;
            max-width: 900px;
            padding-bottom: 50px;
        }

        h1 {
            text-align: center;
            letter-spacing: 5px;
            font-weight: 300;
            color: var(--neon-blue);
            text-shadow: 0 0 15px var(--neon-blue);
        }

        .search-section {
            background: rgba(255, 255, 255, 0.02);
            padding: 20px;
            border: 1px solid rgba(0, 243, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        select, input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            border-bottom: 2px solid var(--neon-blue);
            padding: 14px;
            color: white;
            font-size: 1.1rem;
            outline: none;
            transition: 0.3s;
        }

        input:focus {
            background: rgba(0, 243, 255, 0.05);
            box-shadow: 0 5px 15px rgba(0, 243, 255, 0.1);
        }

        .status {
            margin-top: 15px;
            font-size: .7rem;
            letter-spacing: 2px;
            color: var(--neon-blue);
            text-transform: uppercase;
        }

        .results {
            margin-top: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid var(--neon-blue);
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
            transition: .3s ease;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card:hover {
            background: rgba(0, 243, 255, 0.08);
            transform: translateX(5px);
        }

        .label {
            color: var(--neon-blue);
            font-size: .75rem;
            margin-bottom: 8px;
            display: block;
            font-weight: bold;
        }

        .snippet {
            line-height: 1.8;
            font-size: 1.1rem;
            color: #ddd;
        }

        .highlight {
            background: rgba(0, 243, 255, 0.4);
            color: #fff;
            padding: 2px 0;
            font-weight: bold;
            border-radius: 2px;
        }

        ::placeholder { color: rgba(255, 255, 255, 0.3); }
    </style>
</head>

<body>

<div class="container">
    <h1>DATA SCANNER</h1>

    <div class="search-section">
        <div class="filters">
            <select id="areaFilter">
                <option value="all">সকল এলাকা (All Areas)</option>
                <option value="Dhaka">ঢাকা (Dhaka)</option>
                <option value="Chittagong">চট্টগ্রাম (Chittagong)</option>
            </select>

            <select id="genderFilter">
                <option value="all">লিঙ্গ (All Genders)</option>
                <option value="Male">পুরুষ (Male)</option>
                <option value="Female">মহিলা (Female)</option>
            </select>
        </div>

        <input id="searchBox" placeholder="পিডিএফ এর ভেতরে অনুসন্ধান করুন (উদাঃ নাম বা এলাকা)...">
        <div id="status" class="status">সিস্টেম লোড হচ্ছে...</div>
    </div>

    <div id="results" class="results"></div>
</div>

<script>
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

/* ===== PDF CONFIGURATION ===== */
const pdfCollection = [
    { name:"ঢাকা পুরুষ রিপোর্ট", url:"pdfs/dhaka_male.pdf", area:"Dhaka", gender:"Male" },
    { name:"ঢাকা মহিলা রিপোর্ট", url:"pdfs/dhaka_female.pdf", area:"Dhaka", gender:"Female" },
    { name:"চট্টগ্রাম জেনারেল রিপোর্ট", url:"pdfs/ctg_all.pdf", area:"Chittagong", gender:"All" }
];

let searchIndex = [];

/* ===== BANGLA NORMALIZER ===== 
   This fixes "Juktakkhor" issues by ensuring characters are 
   stored in a consistent Unicode format (NFC).
*/
const cleanBangla = (text) => {
    if (!text) return "";
    return text
        .normalize("NFC") // Combines characters like 'ka' + 'hashant'
        .replace(/[\u200B-\u200D\uFEFF]/g, "") // Remove hidden non-printing chars
        .replace(/\s+/g, " ") // Collapse extra spaces
        .trim();
};

/* ===== LOAD & INDEX PDFs ===== */
async function extractTextFromPDF(url) {
    try {
        const loadingTask = pdfjsLib.getDocument(url);
        const pdf = await loadingTask.promise;
        let fullText = "";

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            
            // PDF.js extracts text items. We join them with spaces.
            const strings = content.items.map(item => item.str);
            fullText += strings.join(" ") + " ";
        }
        return cleanBangla(fullText);
    } catch (error) {
        console.error("Error loading PDF:", url, error);
        return null;
    }
}

async function initSystem() {
    const statusEl = document.getElementById("status");
    let loadedCount = 0;

    for (const doc of pdfCollection) {
        statusEl.innerText = `Indexing: ${doc.name}...`;
        const text = await extractTextFromPDF(doc.url);
        
        if (text) {
            searchIndex.push({ ...doc, content: text });
            loadedCount++;
        }
    }
    statusEl.innerText = `সিস্টেম রেডি: ${loadedCount} টি ফাইল ইনডেক্স করা হয়েছে`;
}

/* ===== SEARCH CORE ===== */
function performSearch() {
    const query = cleanBangla(document.getElementById("searchBox").value);
    const selectedArea = document.getElementById("areaFilter").value;
    const selectedGender = document.getElementById("genderFilter").value;
    const resultsContainer = document.getElementById("results");

    resultsContainer.innerHTML = "";

    if (query.length < 2) return;

    searchIndex.forEach(doc => {
        // Filter logic
        if (selectedArea !== "all" && doc.area !== selectedArea) return;
        if (selectedGender !== "all" && doc.gender !== selectedGender && doc.gender !== "All") return;

        // Search logic
        if (doc.content.includes(query)) {
            const index = doc.content.indexOf(query);
            
            // Create a snippet for context
            const start = Math.max(0, index - 60);
            const end = Math.min(doc.content.length, index + 100);
            let snippet = doc.content.substring(start, end);

            // Highlight the query
            const highlightedSnippet = snippet.split(query).join(`<span class="highlight">${query}</span>`);

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
                <span class="label">${doc.name} | Area: ${doc.area}</span>
                <div class="snippet">...${highlightedSnippet}...</div>
            `;
            resultsContainer.appendChild(card);
        }
    });

    if (resultsContainer.innerHTML === "" && query.length >= 2) {
        resultsContainer.innerHTML = `<div style="text-align:center; color:gray; margin-top:20px;">কোনো ফলাফল পাওয়া যায়নি</div>`;
    }
}

/* ===== EVENT LISTENERS ===== */
let debounceTimer;
document.getElementById("searchBox").addEventListener("input", () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(performSearch, 300);
});

document.getElementById("areaFilter").addEventListener("change", performSearch);
document.getElementById("genderFilter").addEventListener("change", performSearch);

// Start
initSystem();
</script>

</body>
</html>
